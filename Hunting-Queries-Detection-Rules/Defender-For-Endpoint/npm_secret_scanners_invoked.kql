// Title: Secret-scanning tools invoked by npm scripts
// Product: Sentinel | Defender-For-Endpoint
// ATT&CK: T1552 (Unsecured Credentials), T1036 (Masquerade)
// Data Sources: DeviceProcessEvents
// Description: TruffleHog/Gitleaks/Git-Secrets invoked by npm/postinstall.
// Author: Ahsan M.

let startTime = ago(30d);
DeviceProcessEvents
| where Timestamp >= startTime
| where tolower(ProcessCommandLine) has_any ("trufflehog", "gitleaks", "git-secrets", "detect-secrets")
   or FileName in~ ("trufflehog", "gitleaks", "detect-secrets", "git-secrets")
| where InitiatingProcessFileName in~ ("npm", "npx", "node")
   or tolower(InitiatingProcessCommandLine) has_any ("npm install", "postinstall")
| project Timestamp, DeviceName, AccountName, FileName, ProcessCommandLine, InitiatingProcessFileName, InitiatingProcessCommandLine
| order by Timestamp desc
