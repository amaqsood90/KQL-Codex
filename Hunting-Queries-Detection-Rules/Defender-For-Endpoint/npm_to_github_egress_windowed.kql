// Title: GitHub egress shortly after npm install
// Product: Sentinel | Defender-For-Endpoint
// ATT&CK: T1105 (Exfil over C2), T1041 (Exfil over Web Services)
// Data Sources: DeviceNetworkEvents, DeviceProcessEvents
// Description: Correlates GitHub traffic within a window after npm install.
// Author: Ahsan M.

let startTime = ago(30d);
let installWindow = 30m;
let npmInstalls =
    DeviceProcessEvents
    | where Timestamp >= startTime
    | where tolower(ProcessCommandLine) has_any ("npm install", "npm i")
    | project DeviceId, InstallTime = Timestamp, InitiatingProcessId, ProcessId;

DeviceNetworkEvents
| where Timestamp >= startTime
| where RemoteUrl has_any ("github.com", "api.github.com", "raw.githubusercontent.com", "gist.github.com")
   or (RemotePort in (22, 443) and RemoteIPType == "Public"
       and tolower(InitiatingProcessFileName) in ("git", "gh", "node", "curl", "wget"))
| join kind=innerunique (
    DeviceProcessEvents
    | where Timestamp >= startTime
    | project DeviceId, PTime = Timestamp, InitiatingProcessId, ProcessId, FileName, ProcessCommandLine
) on DeviceId, InitiatingProcessId
| join kind=leftouter npmInstalls on DeviceId
| where isnotempty(InstallTime) and PTime between (InstallTime .. InstallTime + installWindow)
| project Timestamp, DeviceName, InitiatingProcessFileName, InitiatingProcessCommandLine,
          RemoteUrl, RemoteIP, RemotePort, FileName, ProcessCommandLine
| order by Timestamp desc
